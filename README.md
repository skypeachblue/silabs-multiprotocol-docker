# Docker Version of iHost SiLabs Zigbee/OpenThread Multiprotocol Home Assistant Add-on

Allows using Multi-PAN on Silicon Labs based radios such as the SONOFF ZBDongle-E with Docker-based Home Assistant installations.

## About

Based on the [iHost SiLabs Multiprotocol Add-on](https://github.com/iHost-Open-Source-Project/hassio-ihost-addon/tree/master/hassio-ihost-silabs-multiprotocol).

The `hassio-ihost-silabs-multiprotocol` Docker image provides:
- CPCd v4.6.1.0
- mDNSd
- OTBR agent and web interface (OpenThread SDK 2.6.1.0)
- Zigbee daemon via TCP socket (EmberZNet SDK 8.1.1.0)

For Matter support, the compose file includes python-matter-server v8.1.0 as well.

## Setup

- Raspberry Pi 4B with Docker-based installations:
    - Home Assistant
    - mosquitto (or other mqtt broker)
    - zigbee2mqtt
- SONOFF ZBDongle-E
    - flashed with [donglee_mg21_multipan_beta_4.6.0_115200.gbl](https://github.com/iHost-Open-Source-Project/hassio-ihost-sonoff-dongle-flasher/blob/ce1c2f8a3d4ad13664ae3c0dfbbd1b56cdcafe0f/firmware-build/donglee_mg21_multipan_beta_4.6.0_115200.gbl) Multi-PAN firmware
- TP-Link UB500 Nano Bluetooth 5.3 Adapter (for commissioning Matter-over-Thread devices)

## Configuration

The container will expose:
- OTBR REST API on port 8081 (this cannot be changed at the moment so make sure that port 8081 is available)
- OTBR web interface on port 9998 (can be changed or disabled)
- Zigbee daemon on port 9999 (can be changed)
- python-matter-server on port 5580

#### Zigbee

Configure zigbee2mqtt first. The adapter should be configured as follows:

```
serial:
  port: tcp://<YOUR_IP>:9999
  adapter: ember
  baudrate: 115200
  rtscts: false
```

You may need to restart zigbee2mqtt. Then configure your Zigbee network via the web interface.

#### Thread

The OpenThread Border Router can be configured via the web interface on `http://<YOUR_IP>:9998`.
Form a new network and make sure it is set to the same channel as your Zigbee network.

#### Home Assistant

Add and configure the following integrations:
- MQTT (Enter IP and port of your MQTT broker)
- OpenThread Border Router (Enter http://<YOUR_IP>:8081 as the REST endpoint)
- Thread (Your network should appear automatically. Set it as the default)
- Matter

## Usage

The docker container requires access to your local Home Assistant API.
For this, a long-lived access token is needed.
This token can be generated by navigating to `http://<your-local-homeassistant-url>/profile/security` and clicking `Create token` at the bottom.
Configure your local URL and access token inside the docker-compose.yml file.
Then start the container: `docker compose up --build`

Some notes:
- This setup will not work reliably if your Zigbee and Thread network are not set to the same channel
- Should be used together with zigbee2mqtt (ZHA does not officially support Multi-PAN firmware, it may work but I haven't tested it)
- I was not able to get the Raspberry Pi's internal Bluetooth adapter to work reliably for commissioning Matter devices, so I recommend an external Bluetooth adapter
- Make sure that no other services (e.g. Home Assistant) are using this external adapter at the same time
- Network mode has to be set to `host` for mDNS support (required for Thread)
